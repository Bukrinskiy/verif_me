# AI детектор лжи — MVP

## Назначение проекта
Сервис (Telegram-бот / Web) для анализа **одного пользовательского запроса**
(текстового или голосового) и генерации **одного ответа** на базе ИИ.

---

## Технологический стек
- PHP 8.2
- MySQL 8+
- PDO
- Telegram Bot API
- OpenAI API (LLM + Speech-to-Text)

---

## OpenAI
- Заполните `openai_api_key` в `config.php`.
- Используемый endpoint: `https://api.openai.com/v1/responses`.

---

## Telegram webhook-бот

### Как создать `bot/config.php` из примера
1. Скопируйте файл:
   ```bash
   cp bot/config.example.php bot/config.php
   ```
2. Заполните значения:
   - `bot_token` — токен Telegram-бота.
   - `api_base_url` — базовый URL вашего проекта (по умолчанию `https://seranking.store/codex`).
   - `webhook_secret` — опциональный секрет для проверки заголовка `X-Telegram-Bot-Api-Secret-Token`.

### Как установить webhook
Вызовите (подставьте токен и URL):
```
https://api.telegram.org/bot<TOKEN>/setWebhook?url=<WEBHOOK_URL>
```

### Как проверить
1. Отправьте текстовое сообщение вашему боту в Telegram.
2. Должен прийти ответ с вердиктом, скором и кратким резюме.

### Voice messages
- Бот поддерживает voice-сообщения (OGG/OPUS), они транскрибируются в текст перед анализом.
- Используется OpenAI transcription model (по умолчанию `gpt-4o-mini-transcribe`).
- Как тестировать: отправьте voice-сообщение вашему боту в Telegram.

---

## Ключевые правила MVP
- Один запрос пользователя = один новый диалог
- Диалог нельзя продолжать, дополнять или редактировать
- Пользователь отправляет **либо текст, либо аудио**
- Аудио **всегда транскрибируется в текст** до анализа
- В ИИ **всегда передаётся только текст**
- Каждый диалог является завершённой сущностью
- Диалог может быть только в одном из состояний:
  - `done`
  - `error`
- Никаких сложных контекстов и цепочек сообщений

---

## Архитектура базы данных

Используется **двухтабличная модель**:
- `dialogs` — сущность диалога (одного запроса)
- `messages` — сообщения внутри диалога

---

## Таблица `dialogs`

Хранит сам факт диалога и итог его обработки.

### Назначение
- Один диалог = один пользовательский запрос
- Диалог не может быть продолжен или изменён
- Используется для идентификации пользователя и статуса обработки

### Поля
- `id` — INT, первичный ключ  
  **Идентификатор диалога**
- `telegram_user_id` — BIGINT  
  Уникальный числовой идентификатор пользователя Telegram  
  Используется для идентификации пользователя и его истории запросов
- `status` — ENUM(`done`, `error`)  
  `done` — запрос успешно обработан  
  `error` — произошла ошибка на любом этапе обработки
- `created_at` — DATETIME  
  Время получения запроса от пользователя
- `finished_at` — DATETIME, NULL  
  Время завершения обработки (ответ получен или зафиксирована ошибка)

### Примечания
- Тип входного запроса (текст / аудио) **не сохраняется**  
  Аудио всегда транскрибируется в текст до анализа
- Промежуточный статус `processing` **не используется**
- Логины и usernames Telegram **не используются** для идентификации пользователей

---

## Таблица `messages`

Хранит сообщения внутри диалога.

### Поля
- `id` — INT, первичный ключ
- `dialog_id` — INT  
  Идентификатор диалога  
  (внешний ключ → `dialogs.id`)
- `role` — ENUM(`user`, `assistant`, `system`)
- `content` — TEXT  
  Текст сообщения
- `created_at` — DATETIME  
  Время создания сообщения

### Использование ролей
- `user`  
  Текстовый запрос пользователя  
  **или** результат транскрибации аудио
- `assistant`  
  Финальный ответ ИИ
- `system`  
  Технические сообщения:
  - ошибки транскрибации
  - диагностическая информация

---

## Связь таблиц `dialogs` и `messages` (ВАЖНО)

Поле `id` в таблице `dialogs` **является идентификатором диалога**.

Во всех связанных таблицах это же значение используется
под именем `dialog_id`.

То есть:
- `dialogs.id` = **ID диалога**
- `messages.dialog_id` → ссылается на `dialogs.id`

Это одно и то же значение, но с разными именами:
- `id` — внутри таблицы `dialogs`
- `dialog_id` — во всех внешних таблицах

В таблице `dialogs` **нет отдельного поля `dialog_id`** —
роль идентификатора диалога выполняет поле `id`.

---

## Логика работы (MVP)

1. Пользователь отправляет текст или аудио
2. Создаётся запись в `dialogs`
3. Если запрос аудио:
   - выполняется транскрибация
   - результат используется как текст запроса
4. Текст запроса сохраняется в `messages` с `role = user`
5. Генерируется ответ ИИ
6. Ответ сохраняется в `messages` с `role = assistant`
7. Диалог помечается как:
   - `done` — при успешной обработке
   - `error` — при любой ошибке
8. Заполняется `finished_at`

---

## Ограничения MVP
- Нет редактирования сообщений
- Нет продолжения диалогов
- Нет истории контекста
- Нет ветвления
- Нет повторных сообщений в рамках одного диалога

---

## Правила разработки
- Этот README является **источником истины** по архитектуре
- Codex **НЕ имеет права** менять архитектуру без явного запроса
- Все SQL-запросы выполняются через PDO
- Используется только MySQL (SQLite запрещён)

---

## Потенциальное развитие (не MVP)
- Контекстные диалоги
- Очереди обработки
- История диалогов пользователя
- Аналитика
- Платёжная логика
